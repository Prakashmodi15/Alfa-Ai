<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>🤖 Alfa AI</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body, html {margin:0;padding:0;height:100%;width:100%;background:#f0f2f5;}
#chatContainer {display:none; position:fixed; top:0; left:0; width:100%; height:100%; flex-direction:column; z-index:9999; box-shadow:0 0 15px rgba(0,0,0,0.2);}
.message {max-width:70%; padding:10px 15px; margin-bottom:8px; border-radius:20px; word-wrap:break-word; animation:fadeIn 0.3s; white-space:pre-wrap;}
@keyframes fadeIn {from {opacity:0;} to {opacity:1;}}
.typingDots span{animation: blink 1.4s infinite; display:inline-block;}
.typingDots span:nth-child(2){animation-delay:0.2s;}
.typingDots span:nth-child(3){animation-delay:0.4s;}
@keyframes blink{0%,80%,100%{opacity:0;}40%{opacity:1;}}
.avatar{width:32px;height:32px;border-radius:50%;display:inline-block;margin-right:8px;vertical-align:top;}
.timestamp{font-size:0.7rem;color:gray;margin-left:5px;}
.codeBlock{background:#1e1e1e;color:#dcdcdc;padding:8px 12px;border-radius:8px;font-family:monospace;overflow-x:auto;}
a{color:#2563eb;text-decoration:underline;}
#chatButton{transition:transform 0.3s ease, background-color 0.3s ease;}
#chatButton:hover{transform:scale(1.1); background-color:#0056b3;}
</style>
</head>
<body class="transition-colors duration-500">

<!-- Floating Chat Button -->
<button id="chatButton" class="fixed bottom-5 right-5 bg-blue-600 text-white px-6 py-3 rounded-full shadow-lg z-50" onclick="toggleChat()">Chat</button>

<!-- Chat Container -->
<div id="chatContainer" class="flex flex-col bg-white dark:bg-gray-800 transition-colors duration-500">
  <!-- Header -->
  <div class="flex justify-between items-center bg-blue-600 text-white p-4">
    <span class="font-bold">🤖 Alfa AI</span>
    <div class="flex items-center gap-2">
      <button id="darkModeToggle" class="text-white hover:text-gray-200">🌓</button>
      <button onclick="toggleChat()" class="text-2xl font-bold hover:text-gray-200">×</button>
    </div>
  </div>

  <!-- Messages -->
  <div id="chatMessages" class="flex-1 p-4 overflow-y-auto bg-gray-100 dark:bg-gray-900 transition-colors duration-500"></div>

  <!-- Input -->
  <div class="flex p-4 gap-2 border-t border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 transition-colors duration-500">
    <input type="text" id="userInput" placeholder="Type your message or speak..." class="flex-1 border rounded-full px-4 py-2 outline-none focus:ring-2 focus:ring-blue-400 dark:bg-gray-700 dark:text-white"/>
    <button onclick="startVoice()" class="px-4 py-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition">🎤</button>
    <button onclick="sendMessage()" class="px-4 py-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition">Send</button>
  </div>
</div>

<script>
// Elements
const chatContainer=document.getElementById('chatContainer');
const chatButton=document.getElementById('chatButton');
const chatMessages=document.getElementById('chatMessages');
const userInput=document.getElementById('userInput');
const darkModeToggle=document.getElementById('darkModeToggle');

// Toggle chat
function toggleChat(){
  const isHidden=chatContainer.style.display==='none'||chatContainer.style.display==='';
  chatContainer.style.display=isHidden?'flex':'none';
  chatButton.style.display=isHidden?'none':'block';
  if(isHidden) userInput.focus();
}

// Dark mode
darkModeToggle.addEventListener('click',()=>{document.body.classList.toggle('dark');});

// Detect language
function detectLanguage(text){const hindi=/[\u0900-\u097F]/;return hindi.test(text)?'hi-IN':'en-US';}

// Append user/bot message with markdown/code
function appendMessage(text,isUser){
  const div=document.createElement('div'); div.className='flex items-start '+(isUser?'justify-end':'justify-start');
  const avatar=document.createElement('span'); avatar.className='avatar'; avatar.textContent=isUser?'🧑':'🤖';
  const msgDiv=document.createElement('div'); msgDiv.className='message '+(isUser?'bg-blue-600 text-white':'bg-gray-200 text-black dark:bg-gray-700 dark:text-white');

  // Markdown: code blocks
  const codeRegex=/```([\s\S]*?)```/g;
  text=text.replace(codeRegex,(match, p1)=>`<div class="codeBlock">${p1}</div>`);

  // Links
  const linkRegex=/https?:\/\/[^\s]+/g;
  text=text.replace(linkRegex,match=>`<a href="${match}" target="_blank">${match}</a>`);

  msgDiv.innerHTML=text;

  const timeSpan=document.createElement('span'); timeSpan.className='timestamp';
  const now=new Date(); timeSpan.textContent=`${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`;
  msgDiv.appendChild(timeSpan);

  if(isUser){div.appendChild(msgDiv); div.appendChild(avatar);} else{div.appendChild(avatar); div.appendChild(msgDiv);}
  chatMessages.appendChild(div);
  chatMessages.scrollTop=chatMessages.scrollHeight;
  if(!isUser) playVoice(text);
}

// Typing animation
function appendTyping(){
  const div=document.createElement('div'); div.className='flex items-start mr-auto';
  const avatar=document.createElement('span'); avatar.className='avatar mr-2'; avatar.textContent='🤖';
  const msgDiv=document.createElement('div'); msgDiv.className='message bg-gray-200 text-black dark:bg-gray-700 dark:text-white';
  const dots=document.createElement('span'); dots.className='typingDots'; dots.innerHTML='<span>.</span><span>.</span><span>.</span>';
  msgDiv.appendChild(dots); div.appendChild(avatar); div.appendChild(msgDiv);
  chatMessages.appendChild(div); chatMessages.scrollTop=chatMessages.scrollHeight;
  return {div,msgDiv,dots};
}

// Progressive typing for multi-line
async function progressiveText(container,text){
  container.innerHTML='';
  let i=0;
  while(i<text.length){
    container.innerHTML+=text[i];
    chatMessages.scrollTop=chatMessages.scrollHeight;
    await new Promise(r=>setTimeout(r,25));
    i++;
  }
}

// Send message
async function sendMessage(){
  const msg=userInput.value.trim(); if(!msg) return;
  appendMessage(msg,true); userInput.value='';
  const typingObj=appendTyping();
  try{
    const res=await fetch('/api/alfa',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:msg,lang:detectLanguage(msg)})});
    const data=await res.json();
    typingObj.div.remove();
    if(data.reply){
      const div=document.createElement('div'); div.className='flex items-start mr-auto';
      const avatar=document.createElement('span'); avatar.className='avatar mr-2'; avatar.textContent='🤖';
      const msgDiv=document.createElement('div'); msgDiv.className='message bg-gray-200 text-black dark:bg-gray-700 dark:text-white';
      div.appendChild(avatar); div.appendChild(msgDiv); chatMessages.appendChild(div); chatMessages.scrollTop=chatMessages.scrollHeight;
      await progressiveText(msgDiv,data.reply);
      playVoice(data.reply);
    }else appendMessage('⚠️ Something went wrong',false);
  }catch(err){typingObj.div.remove(); appendMessage('⚠️ Network error',false);}
}

// Enter key
userInput.addEventListener('keypress',e=>{if(e.key==='Enter') sendMessage();});

// Voice input
function startVoice(){
  const recognition=new (window.SpeechRecognition||window.webkitSpeechRecognition)();
  recognition.lang='hi-IN'; recognition.interimResults=false; recognition.maxAlternatives=1; recognition.start();
  recognition.onresult=(event)=>{userInput.value=event.results[0][0].transcript; sendMessage();}
  recognition.onerror=(event)=>{alert('Voice recognition error: '+event.error);}
}

// Voice output
function playVoice(text){
  const lang=detectLanguage(text);
  const utter=new SpeechSynthesisUtterance(text); utter.lang=lang; utter.rate=1; utter.pitch=1; speechSynthesis.speak(utter);
}
</script>
</body>
</html>
